<!DOCTYPE html>
<html lang="en">
<head>
    <title>Как потерять данные пользователей, или История девяти байтов</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=792, user-scalable=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="stylesheet" href="node_modules/shower-bright/styles/screen.css">

    <style>
        .slide.shout.dark {
            background-color: #000;
        }

        .slide.shout.golden {
            background-color: #fd3;
        }

        .slide.shout.golden h2 {
            color: #333;
        }

        .slide.shout h2 {
            right: 0;
        }
    </style>
</head>
<body class="list">

<header class="caption">
    <h1>Как потерять данные пользователей,<br>или История девяти байтов</h1>

    <p><a href="https://twitter.com/igorlukanin" target="_blank">Игорь Луканин</a> для <a href="https://twitter.com/search?q=%23конфур&src=typd" target="_blank">КонфУРа</a> в ноябре 2015 года</p>
</header>

<section class="slide cover">
    <div>
        <img src="pictures/true-story.jpg">
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Как устроен сервис</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Почему NoSQL?</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>#1.<br>Компании<br>не связаны</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>#2.<br>Одна коллекция,<br>а не 30 таблиц</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>#3.<br>Избавились<br>от бойлерплейта</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Company</h2>
        <pre>
            <code>public Guid Id { get; set; }</code>
            <code>public string Inn { get; set; }</code>
            <code>public List&lt;PaperDocument&gt; <mark class="important">PaperDocuments</mark> { get; set; }</code>
            <code>public List&lt;RknNotification&gt; <mark class="important">RknNotifications</mark> { get; set; }</code>
            <code><mark class="comment">// Ещё 42 таких же поля</mark></code>
        </pre>
    </div>
</section>
<!-- TODO: Добавить подсветку синтаксиса -->

<section class="slide">
    <div>
        <h2>ICompanyRepository</h2>
        <pre>
            <code>void Remove(Guid id);</code>
            <code>void Save(Company company);</code>
            <code>Company Find(Guid id);</code>
            <code>Company FindByUid(string uid);</code>
            <code>IEnumerable&lt;Company&gt; FindByInn(string inn);</code>
            <code>IEnumerable&lt;Company&gt; FindWithRknNotifications();</code>
            <code><mark class="comment">// Ещё 13 таких же методов</mark></code>
        </pre>
    </div>
</section>
<!-- TODO: Добавить подсветку синтаксиса -->

<section class="slide">
    <div>
        <h2>CompanyRepository</h2>
        <pre>
            <code>public IEnumerable&lt;Company&gt; FindByInn(string inn) {</code>
            <code>    return mongoCollection.AsQueryable()</code>
            <code>        .Where(company => company.Inn == inn)</code>
            <code>        .Select(<mark class="important">Prepare</mark>);</code>
            <code>}</code>
            <code><mark class="comment">// И ещё много более сложных запросов</mark></code>
        </pre>
    </div>
</section>
<!-- TODO: Добавить подсветку синтаксиса -->

<section class="slide">
    <div>
        <h2>CompanyRepository</h2>
        <pre>
            <code>public void Save(Company company) {</code>
            <code>    collection.Save(<mark class="important">PrepareSave</mark>(company));</code>
            <code>}</code>
        </pre>
    </div>
</section>
<!-- TODO: Добавить подсветку синтаксиса -->

<section class="slide">
    <div>
        <h2>Вычисление данных</h2>
        <pre>
            <code><mark class="comment">// Stored храним в базе данных, Calculated вычисляем</mark></code>
            <code>Stored<sub>0</sub> + Calculated<sub>0</sub> = <mark class="important">Prepare</mark>    (Stored<sub>0</sub>)</code>
            <code>Stored<sub>1</sub> + Calculated<sub>1</sub> = Process     (Stored<sub>0</sub> + Calculated<sub>0</sub>)</code>
            <code>Stored<sub>2</sub>               = <mark class="important">PrepareSave</mark>(Stored<sub>1</sub> + Calculated<sub>1</sub>)</code>
        </pre>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Зачем<br>вычислять?</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>#1.<br>Дублирующиеся данные</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>#2.<br>Циклические ссылки</h2>
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/document-with-checks.png">
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Однажды...</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>CompanyRepository</h2>
        <pre>
            <code>public IEnumerable&lt;Company&gt; FindAll()</code>
            <code>    return mongoCollection.FindAll();</code>
            <code>}</code>
        </pre>
    </div>
</section>
<!-- TODO: Добавить подсветку синтаксиса -->

<section class="slide cover">
    <div>
        <img src="pictures/hmm.png">
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Код-ревью</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Тестирование</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>И в продакшн!</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Через два дня Антон заметил...</h2>
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/document-without-checks.png">
    </div>
</section>

<section class="slide">
    <div>
        <h2><span class="strikethrough">Сломанное</span> вычисление данных</h2>
        <pre>
            <code><mark class="comment">// Stored храним в базе данных, Calculated вычисляем</mark></code>
            <code>Stored<sub>0</sub> + <mark class="important strikethrough">Calculated<sub>0</sub></mark> =              Stored<sub>0</sub></code>
            <code>Stored<sub>1</sub> + <mark class="important strikethrough">Calculated<sub>1</sub></mark> = Process     (Stored<sub>0</sub> + Calculated<sub>0</sub>)</code>
            <code><mark class="important strikethrough">Stored<sub>2</sub></mark>             <sub> </sub> = <mark class="important">PrepareSave</mark>(Stored<sub>1</sub> + Calculated<sub>1</sub>)</code>
        </pre>
    </div>

    <style>
        .hidden {
            opacity: 0;
        }

        .strikethrough {
            background-color: #f66 !important;
            color: #fff;
            padding-left: .2em !important;
            padding-right: .2em !important;
        }
    </style>
</section>

<section class="slide shout">
    <div>
        <h2>Кто виноват?</h2>
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/bender.png" width="1024">
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/hangfire.png">
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Бэкапов нет</h2>
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/wasted.jpg">
    </div>
</section>

<section class="slide shout dark">
    <div>
        <h2>Пострадало<br>4530 компаний</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>#1. MS SQL</h2>
    </div>
</section>

<section class="slide shout dark">
    <div>
        <h2>Осталось<br>2170 компаний</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>#2. pisa.exe</h2>
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/pdf.png">
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/tmp.png">
    </div>
</section>

<section class="slide shout dark">
    <div>
        <h2>Осталось<br>150 компаний</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>#3. Эксперты</h2>
    </div>
</section>

<section class="slide shout dark">
    <div>
        <h2>Осталось<br>150 компаний</h2>
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Посылаем<br>150 писем</h2>
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/letter.png">
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/marine.png">
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Два письма<br>и два звонка</h2>
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/answer-1.png">
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/answer-2.png">
    </div>
</section>

<section class="slide shout">
    <div>
        <h2>Чему мы научились</h2>
    </div>
</section>

<section class="slide cover">
    <div>
        <img src="pictures/captain.png">
    </div>
</section>

<section class="slide shout golden">
    <div>
        <h2>Избыточность<br>данных</h2>
    </div>
</section>

<section class="slide shout golden">
    <div>
        <h2>Бэкапы<br>&nbsp;</h2>
    </div>
</section>

<section class="slide shout golden">
    <div>
        <h2>Функциональные<br>тесты</h2>
    </div>
</section>

<section class="slide shout golden">
    <div>
        <h2>Код-ревью<br>&nbsp;</h2>
    </div>
</section>

<section class="slide shout golden">
    <div>
        <h2>Поддержка<br>инфраструктуры</h2>
    </div>
</section>

<section class="slide shout golden">
    <div>
        <h2>Ружьё на стене<br>и грабли в коде</h2>
    </div>
</section>

<section class="slide shout golden">
    <div>
        <h2>Удовольствие<br>для каждого</h2>
    </div>
</section>

<section class="slide shout golden">
    <div>
        <h2>Рассказывайте<br>о фейлах</h2>
    </div>
</section>

<section class="slide shout" id="me">
    <div>
        <h2><a href="https://twitter.com/igorlukanin" target="_blank">@igorlukanin</a></h2>
    </div>

    <style>
        #me a {
            background-image: none;
        }

        #me h2 {
            text-align: center;
            left: 0;
            right: 0;
        }
    </style>
</section>
<!-- TODO: Статья от Ильяхова — как извиняться -->

<p class="badge"><a href="https://github.com/igorlukanin/konfur-story-of-nine-bytes" target="_blank">Fork me on GitHub</a></p>

<div class="progress">
    <div></div>
</div>

<script src="node_modules/shower-core/shower.min.js"></script>

<!-- Yandex.Metrika counter <script type="text/javascript"> (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter33414963 = new Ya.Metrika({ id:33414963, clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true, trackHash:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="https://mc.yandex.ru/watch/33414963" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->

</body>
</html>